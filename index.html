<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Borbarad-DB Data Filler (DSA 4.1 Sonderfertigkeiten)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg:#0b1020; --panel:#121833; --ink:#e8ecff; --muted:#aab3d4; --accent:#8fb3ff; --ok:#2ecc71; --warn:#ffb347; --err:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1020 50%,#0b152a);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid #1e274a;background:#0b1226;position:sticky;top:0;z-index:5}
    header h1{font-size:16px;margin:0;font-weight:600;letter-spacing:.2px}
    .container{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 53px)}
    aside{border-right:1px solid #1e274a;background:#0c1430;padding:12px;overflow:auto}
    main{padding:16px;overflow:auto}
    .card{background:var(--panel);border:1px solid #1f2a52;border-radius:14px;padding:12px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    select, input[type="text"], input[type="number"], input[type="date"], textarea{
      width:100%;background:#0d1534;color:var(--ink);border:1px solid #26305c;border-radius:10px;padding:8px 10px;outline:none
    }
    textarea{min-height:70px}
    label{font-size:12px;color:var(--muted)}
    .btn{background:#1a2551;border:1px solid #2a3a78;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:linear-gradient(180deg,#2a5fff,#5f89ff);border-color:#5f89ff;color:#07122a}
    .btn.warn{background:#3a2a10;border-color:#6a4b12;color:#ffd7a3}
    .btn.ghost{background:transparent;border-color:#31406e}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#101b3f;border:1px solid #27356a;border-radius:999px;padding:6px 10px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #223066;padding:8px;vertical-align:top}
    th{position:sticky;top:0;background:#0e1635;z-index:1;text-align:left}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .error{color:var(--err)}
    .success{color:var(--ok)}
    .grid{display:grid;gap:10px}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .help{font-size:12px;color:#b4c0ee}
    kbd{background:#0a1436;border:1px solid #2a3a78;padding:1px 6px;border-radius:6px;font-size:12px}
    .small{font-size:12px}
    .badge{display:inline-block;background:#132052;border:1px solid #2a3a78;border-radius:8px;padding:2px 6px;font-size:11px;color:#c8d6ff}
  </style>
</head>
<body>
<header>
  <h1>üßô‚Äç‚ôÇÔ∏è Borbarad-DB Data Filler ‚Äì DSA 4.1 Sonderfertigkeiten</h1>
  <span class="pill">Status: <span id="status" class="muted">Verbinde‚Ä¶</span></span>
  <span class="pill">Projekt: <span class="muted">Supabase</span></span>
</header>

<div class="container">
  <aside class="stack">
    <div class="card stack">
      <div class="stack">
        <label>Supabase URL</label>
        <input id="sb-url" type="text" value="https://uzgizoikrricctzznlzr.supabase.co" />
        <label>Anon/Public API Key</label>
        <input id="sb-key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6Z2l6b2lrcnJpY2N0enpubHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MDc1MTksImV4cCI6MjA3MjQ4MzUxOX0.MJFMo6PrBXq_3xQGqYeyMKZx0JTqouFBW3eqteXgsm8" />
        <button id="btn-connect" class="btn">Neu verbinden</button>
        <div class="help">‚ö†Ô∏è Nutze hier nur <b>Public/Anon</b>-Keys. F√ºr Admin-Aufgaben <i>nicht</i> geeignet.</div>
      </div>
    </div>

    <div class="card stack">
      <label>Tabelle</label>
      <select id="table-select"></select>
      <div class="row">
        <button id="btn-load" class="btn">Laden</button>
        <button id="btn-new" class="btn ghost">Neu anlegen</button>
      </div>
      <div class="small muted">Tipp: <kbd>Strg</kbd>+<kbd>K</kbd> f√ºr Suche in Datens√§tzen.</div>
    </div>

    <div class="card stack">
      <div class="small help">Schnellzugriff</div>
      <div class="grid cols-2">
        <button class="btn small" data-jump="sonderfertigkeit">Sonderfertigkeit</button>
        <button class="btn small" data-jump="sf_stufe">Stufe</button>
        <button class="btn small" data-jump="sf_kosten">AP-Kosten</button>
        <button class="btn small" data-jump="sf_quelle">Quelle</button>
        <button class="btn small" data-jump="sf_modifikator">Modifikator</button>
        <button class="btn small" data-jump="sf_nutzung">Nutzung</button>
        <button class="btn small" data-jump="sf_pre_sf">Voraus. SF</button>
        <button class="btn small" data-jump="sf__talent">‚Üî SF‚ÜîTalent</button>
      </div>
    </div>

    <div class="card stack">
      <div class="small help">Legende</div>
      <span class="badge">FK</span> Fremdschl√ºssel-Dropdown<br/>
      <span class="badge">ENUM</span> feste Auswahl<br/>
      <span class="badge">NULL</span> leer lassen
    </div>
  </aside>

  <main class="stack">
    <div class="card stack">
      <div class="toolbar">
        <input id="search-input" type="text" placeholder="Suche (z. B. name: Finte)" />
        <button id="btn-search" class="btn">Suchen</button>
        <span class="muted small" id="rows-count"></span>
        <span style="flex:1"></span>
        <button id="btn-refresh" class="btn ghost">üîÑ Aktualisieren</button>
      </div>
      <div id="rows-wrap" style="overflow:auto;max-height:40vh;margin-top:8px">
        <table id="rows-table"></table>
      </div>
      <div class="row">
        <button id="prev-page" class="btn ghost">‚óÄ Zur√ºck</button>
        <button id="next-page" class="btn ghost">Weiter ‚ñ∂</button>
        <span class="muted small" id="page-info"></span>
      </div>
    </div>

    <div class="card stack">
      <div class="toolbar">
        <h3 style="margin:0;font-size:16px">Formular</h3>
        <span id="form-mode" class="muted small">Neu</span>
        <span style="flex:1"></span>
        <button id="btn-clear" class="btn ghost">Felder leeren</button>
      </div>
      <form id="editor" class="grid cols-3"></form>
      <div class="row">
        <button id="btn-save" class="btn primary">üíæ Speichern</button>
        <button id="btn-delete" class="btn warn">üóë L√∂schen</button>
        <span id="op-status" class="muted small"></span>
      </div>
    </div>
  </main>
</div>

<script>
/** ========= Basiskonfiguration ========= **/
const ENUMS = {
  attribute_code: ['MU','KL','IN','CH','FF','GE','KO','KK'],
  aktionstyp: ['passiv','frei','aktion','reaktion','permanent'],
  ressourcen_typ: ['AP','AsP','KaP','AuP','LE','sonstige'],
  voraussetz_logik: ['alle','mindestens_eine'],
  sf_status: ['offiziell','inoffiziell','hausregel','entfernt'],
  wirk_operator: ['add','mult','ersetze'],
  vergleich_op: ['>=','>','=','<=','<','!=']
};

// Schema-Definition: Tabellen + Spalten (Typen + optionale FK)
const SCHEMA = {
  // === Stammdaten ===
  talent: {
    label: 'Talente',
    pk: 'id',
    columns: {
      id: {type:'integer', readonly:true},
      name: {type:'text', required:true},
      gruppe: {type:'text', required:true},
      regelwerk: {type:'text', default:'DSA 4.1'}
    }
  },
  waffengruppe: {
    label:'Waffengruppen',
    pk:'id',
    columns: { id:{type:'integer',readonly:true}, name:{type:'text',required:true} }
  },
  tradition: {
    label:'Traditionen',
    pk:'id',
    columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true}, art:{type:'text',required:true} }
  },
  vorteil: { label:'Vorteile', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },
  nachteil: { label:'Nachteile', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },
  quelle: {
    label:'Quellen',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      code:{type:'text',required:true},
      titel:{type:'text',required:true},
      auflage:{type:'text'},
      verlag:{type:'text'},
      jahr:{type:'integer'}
    }
  },
  tag: { label:'Tags', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },

  // === Kern: Sonderfertigkeit ===
  sonderfertigkeit: {
    label:'Sonderfertigkeiten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      name:{type:'text',required:true},
      kurzname:{type:'text'},
      kategorie:{type:'text',required:true}, // Freitext: Allgemein/Kampf/Magie/Liturgie/‚Ä¶
      status:{type:'enum', enum:'sf_status', default:'offiziell'},
      regelwerk:{type:'text', default:'DSA 4.1'},
      beschreibung_kurz:{type:'textarea'},
      einzigartig:{type:'boolean', default:false},
      stapelbar:{type:'boolean', default:false},
      bemerkung:{type:'textarea'}
    }
  },

  // Verkn√ºpfungen
  sf__tag: {
    label:'SF ‚Üî Tag',
    pk:['sf_id','tag_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      tag_id:{type:'fk', ref:{table:'tag', value:'id', label:'name'}, required:true}
    }
  },
  sf__talent: {
    label:'SF ‚Üî Talent',
    pk:['sf_id','talent_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      talent_id:{type:'fk', ref:{table:'talent', value:'id', label:'name'}, required:true}
    }
  },
  sf__waffengruppe: {
    label:'SF ‚Üî Waffengruppe',
    pk:['sf_id','waffengruppe_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      waffengruppe_id:{type:'fk', ref:{table:'waffengruppe', value:'id', label:'name'}, required:true}
    }
  },
  sf__tradition: {
    label:'SF ‚Üî Tradition',
    pk:['sf_id','tradition_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      tradition_id:{type:'fk', ref:{table:'tradition', value:'id', label:'name'}, required:true}
    }
  },

  // Stufen/Varianten + Kosten + Quelle
  sf_stufe: {
    label:'Stufen/Varianten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      bezeichnung:{type:'text',required:true},
      reihenfolge:{type:'integer',default:1}
    }
  },
  sf_kosten:{
    label:'AP-Kosten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      betrag:{type:'integer'},
      ist_variabel:{type:'boolean',default:false},
      formel:{type:'text'},
      bemerkung:{type:'textarea'}
    }
  },
  sf_quelle:{
    label:'SF-Quelle',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      quelle_id:{type:'fk',ref:{table:'quelle',value:'id',label:'code'}, required:true},
      seite:{type:'text'},
      errata_hint:{type:'textarea'}
    }
  },

  // Voraussetzungen
  sf_voraussetzung_text:{
    label:'Voraussetzung (Text)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      text:{type:'textarea',required:true}
    }
  },
  sf_pre_attribut:{
    label:'Voraussetzung: Attribut',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      attribut:{type:'enum',enum:'attribute_code',required:true},
      operator:{type:'enum',enum:'vergleich_op',default:'>='},
      wert:{type:'integer',required:true}
    }
  },
  sf_pre_talent:{
    label:'Voraussetzung: Talent',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      talent_id:{type:'fk',ref:{table:'talent',value:'id',label:'name'}, required:true},
      min_taw:{type:'integer',required:true}
    }
  },
  sf_pre_sf:{
    label:'Voraussetzung: SF',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      braucht_sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      min_stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}}
    }
  },
  sf_pre_vorteil:{
    label:'Voraussetzung: Vorteil',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      vorteil_id:{type:'fk',ref:{table:'vorteil',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_nachteil:{
    label:'Voraussetzung: Nachteil',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      nachteil_id:{type:'fk',ref:{table:'nachteil',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_kultur:{
    label:'Voraussetzung: Kultur',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      kultur:{type:'text',required:true}
    }
  },
  sf_pre_profession:{
    label:'Voraussetzung: Profession',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      profession:{type:'text',required:true}
    }
  },
  sf_pre_tradition:{
    label:'Voraussetzung: Tradition',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      tradition_id:{type:'fk',ref:{table:'tradition',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_waffengruppe:{
    label:'Voraussetzung: Waffengruppe',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      waffengruppe_id:{type:'fk',ref:{table:'waffengruppe',value:'id',label:'name'}, required:true}
    }
  },
  sf_voraussetzungsgruppe:{
    label:'Voraussetzungsgruppe',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      logik:{type:'enum',enum:'voraussetz_logik',default:'alle'},
      bemerkung:{type:'text'}
    }
  },
  sf_voraussetzungsgruppe_item:{
    label:'Voraussetzungsgruppe-Item',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      gruppe_id:{type:'fk',ref:{table:'sf_voraussetzungsgruppe',value:'id',label:'id'}, required:true},
      typ:{type:'text',required:true},
      ref_id:{type:'integer'},
      text:{type:'text'}
    }
  },

  // Nutzung / Ressourcen
  sf_nutzung:{
    label:'Nutzung',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      aktivierung:{type:'enum',enum:'aktionstyp',default:'passiv'},
      aktionen_kosten:{type:'numeric'},
      dauer_typ:{type:'text'},
      dauer_wert:{type:'text'},
      bedingung:{type:'text'}
    }
  },
  sf_nutzung_ressource:{
    label:'Nutzungs-Ressource',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      nutzung_id:{type:'fk',ref:{table:'sf_nutzung',value:'id',label:'id'}, required:true},
      typ:{type:'enum',enum:'ressourcen_typ',required:true},
      betrag:{type:'integer'},
      formel:{type:'text'},
      bemerkung:{type:'text'}
    }
  },

  // Wirkung / Modifikatoren / Konflikte / Versionen
  sf_wirkung_text:{
    label:'Wirkung (Text)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      text:{type:'textarea',required:true}
    }
  },
  sf_modifikator:{
    label:'Modifikator (maschinenlesbar)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      ziel_typ:{type:'text',required:true},
      ziel_ref:{type:'text'},
      operator:{type:'enum',enum:'wirk_operator',default:'add'},
      wert_num:{type:'numeric'},
      wert_wuerfel:{type:'text'},
      bedingung:{type:'text'},
      stapelregel:{type:'text'}
    }
  },
  sf_konflikt:{
    label:'Konflikt / Ausschluss',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      ausschluss_sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      bemerkung:{type:'text'}
    }
  },
  sf_version:{
    label:'Version/√Ñnderung',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      gueltig_ab:{type:'date',required:true},
      aenderung:{type:'textarea',required:true}
    }
  }
};

// ======= Laufzeit =======
let client = null;
let currentTable = 'sonderfertigkeit';
let editingRow = null;
let page = 0, pageSize = 25;

const $ = (sel) => document.querySelector(sel);
const $rowsTable = $('#rows-table');
const $rowsCount = $('#rows-count');
const $pageInfo = $('#page-info');
const $status = $('#status');

function initSupabase(){
  const url = $('#sb-url').value.trim();
  const key = $('#sb-key').value.trim();
  client = supabase.createClient(url, key, { auth: { persistSession: false } });
  $status.textContent = 'Verbunden';
}

function fmt(v){
  if (v === null || v === undefined) return '‚Äî';
  if (typeof v === 'boolean') return v ? 'true' : 'false';
  return String(v);
}

function buildTableSelect(){
  const sel = $('#table-select');
  sel.innerHTML = '';
  Object.entries(SCHEMA).forEach(([t,def])=>{
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = `${def.label} (${t})`;
    sel.appendChild(opt);
  });
  sel.value = currentTable;
}

function buildForm(table, row=null){
  const def = SCHEMA[table];
  const form = $('#editor');
  form.innerHTML = '';
  $('#form-mode').textContent = row ? `Bearbeiten (#${row[def.pk] ?? '‚Äì'})` : 'Neu';
  editingRow = row;

  for (const [col, meta] of Object.entries(def.columns)){
    const wrap = document.createElement('div'); wrap.className = 'stack';
    const label = document.createElement('label');
    let badges = [];
    if (meta.type === 'fk') badges.push('FK');
    if (meta.type === 'enum') badges.push('ENUM');
    if (meta.readonly) badges.push('readonly');
    label.innerHTML = `${col}${badges.length? ' <span class="badge">'+badges.join('</span> <span class="badge">')+'</span>':''}`;
    let input;

    const value = row ? row[col] : (meta.default ?? null);

    if (meta.type === 'textarea'){ input = document.createElement('textarea'); input.value = value ?? ''; }
    else if (meta.type === 'boolean'){ input = document.createElement('select');
      ['','true','false'].forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v===''?'(NULL)':v; input.appendChild(o);
      });
      input.value = value === null || value === undefined ? '' : (value ? 'true' : 'false');
    }
    else if (meta.type === 'enum'){
      input = document.createElement('select');
      const opts = ENUMS[meta.enum] || [];
      const nullOpt = document.createElement('option'); nullOpt.value=''; nullOpt.textContent='(NULL)';
      input.appendChild(nullOpt);
      opts.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;input.appendChild(o);});
      input.value = value ?? (meta.default ?? '');
    }
    else if (meta.type === 'fk'){
      input = document.createElement('select');
      input.dataset.fk = JSON.stringify(meta.ref);
      const nullOpt = document.createElement('option'); nullOpt.value=''; nullOpt.textContent='(NULL)';
      input.appendChild(nullOpt);
      // sp√§ter bef√ºllen:
      populateFkOptions(input, value);
      // Suche-Button
      const btn = document.createElement('button'); btn.type='button'; btn.className='btn small ghost'; btn.textContent='üîé Laden';
      btn.onclick = ()=> populateFkOptions(input, input.value || null, true);
      wrap.appendChild(btn);
    }
    else if (meta.type === 'integer'){ input = document.createElement('input'); input.type='number'; input.step='1'; input.value = value ?? ''; }
    else if (meta.type === 'numeric'){ input = document.createElement('input'); input.type='number'; input.step='any'; input.value = value ?? ''; }
    else if (meta.type === 'date'){ input = document.createElement('input'); input.type='date'; input.value = value ?? ''; }
    else { input = document.createElement('input'); input.type='text'; input.value = value ?? ''; }

    input.id = `f_${col}`;
    if (meta.readonly) input.disabled = true;
    wrap.appendChild(label); wrap.appendChild(input);
    form.appendChild(wrap);
  }
}

async function populateFkOptions(selectEl, currentValue=null, forceReload=false){
  try{
    const ref = JSON.parse(selectEl.dataset.fk);
    if (!ref || !ref.table) return;
    // Wenn schon Optionen da sind und kein Reload gefordert ist, nicht doppelt laden
    if (selectEl.options.length>1 && !forceReload) { selectEl.value = currentValue ?? ''; return; }

    selectEl.disabled = true;
    const { data, error } = await client.from(ref.table)
      .select(`${ref.value}, ${ref.label}`).order(ref.label, { ascending: true }).limit(500);
    if (error) throw error;

    // Reset au√üer (NULL)
    [...selectEl.options].slice(1).forEach(o=>o.remove());
    data.forEach(row=>{
      const o=document.createElement('option');
      o.value=row[ref.value];
      o.textContent=`${row[ref.label]} (#${row[ref.value]})`;
      selectEl.appendChild(o);
    });
    selectEl.value = currentValue ?? '';
  }catch(e){
    console.error(e);
    toast(`FK-Optionen nicht ladbar: ${e.message}`, true);
  }finally{
    selectEl.disabled = false;
  }
}

function parseSearch(q){
  // einfache Syntax: "name: Finte" oder "id=12"
  const parts = q.split(/\s+/).filter(Boolean);
  const filters = [];
  for (const p of parts){
    const m = p.match(/^([^:=<>!]+)\s*([:=<>!]{1,2})\s*(.+)$/);
    if (m){ filters.push({col:m[1], op:m[2], val:m[3]}); }
  }
  return filters;
}

async function loadRows(resetPage=false){
  if (resetPage) page = 0;
  const table = currentTable;
  const def = SCHEMA[table];
  const from = page*pageSize;
  const to = from + pageSize - 1;

  let query = client.from(table).select('*', { count: 'exact' }).range(from, to);

  // einfache Default-Sortierung
  if (def.pk && typeof def.pk === 'string') query = query.order(def.pk, { ascending:false });

  // Suche
  const q = $('#search-input').value.trim();
  if (q){
    const fs = parseSearch(q);
    fs.forEach(f=>{
      const opMap = { ':':'ilike', '=':'eq', '==':'eq', '!=':'neq', '>':'gt', '>=':'gte', '<':'lt', '<=':'lte' };
      const sop = opMap[f.op] || 'ilike';
      let val = f.val;
      if (sop==='ilike') val = `%${val}%`;
      query = query.filter(f.col, sop, val);
    });
  }

  const { data, error, count } = await query;
  if (error){ showError(error); return; }
  renderRowsTable(data, def);
  $rowsCount.textContent = `${count ?? data.length} Datens√§tze`;
  $pageInfo.textContent = `Seite ${page+1}`;
}

function renderRowsTable(rows, def){
  const cols = Object.keys(def.columns);
  $rowsTable.innerHTML = '';
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
  const acth = document.createElement('th'); acth.textContent='Aktion'; trh.appendChild(acth);
  thead.appendChild(trh); $rowsTable.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach((row)=>{
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      const td=document.createElement('td');
      td.textContent = fmt(row[c]);
      tr.appendChild(td);
    });
    const act = document.createElement('td');
    const b1 = document.createElement('button'); b1.className='btn small'; b1.textContent='Bearbeiten';
    b1.onclick = ()=> buildForm(currentTable, row);
    const b2 = document.createElement('button'); b2.className='btn small warn'; b2.textContent='L√∂schen';
    b2.onclick = ()=> { buildForm(currentTable, row); doDelete(); };
    act.appendChild(b1); act.appendChild(b2);
    tr.appendChild(act);
    tbody.appendChild(tr);
  });
  $rowsTable.appendChild(tbody);
}

function readFormValues(table){
  const def = SCHEMA[table];
  const payload = {};
  for (const [col, meta] of Object.entries(def.columns)){
    const el = document.getElementById(`f_${col}`);
    if (!el || meta.readonly) continue; // PK/readonly nie mitschicken
    let v = el.value;
    if (v === '') v = null;
    if (meta.type === 'boolean') v = v === null ? null : (v === 'true');
    if (meta.type === 'integer' && v !== null) v = parseInt(v,10);
    if (meta.type === 'numeric' && v !== null) v = parseFloat(v);
    payload[col] = v;
  }
  return payload;
}

async function doSave(){
  const table = currentTable;
  const def = SCHEMA[table];
  const raw = readFormValues(table);

  try{
    $('#btn-save').disabled = true;
    $('#op-status').textContent = 'Speichere‚Ä¶';
    let res, error;

    if (Array.isArray(def.pk)){
      // Composite PK: Upsert mit allen PK-Feldern (hier keine Auto-ID)
      ({ data: res, error } = await client.from(table).upsert(raw).select());
    } else if (editingRow && def.pk){
      // Update: PK nie updaten
      const updatePayload = { ...raw };
      delete updatePayload[def.pk];
      ({ data: res, error } = await client.from(table)
        .update(updatePayload)
        .eq(def.pk, editingRow[def.pk])
        .select());
    } else {
      // Insert: PK entfernen (damit Sequence greift) und NULL-Felder weglassen
      const insertPayload = { ...raw };
      if (typeof def.pk === 'string') delete insertPayload[def.pk];
      for (const k of Object.keys(insertPayload)){
        if (insertPayload[k] === null) delete insertPayload[k];
      }
      ({ data: res, error } = await client.from(table).insert(insertPayload).select());
    }

    if (error) throw error;
    $('#op-status').innerHTML = `<span class="success">‚úÖ Gespeichert</span>`;
    await loadRows(true);
    if (res && res.length) buildForm(table, res[0]);
  }catch(e){
    $('#op-status').innerHTML = `<span class="error">‚ùå ${e.message}</span>`;
  }finally{
    $('#btn-save').disabled = false;
  }
}

async function doDelete(){
  const table = currentTable;
  const def = SCHEMA[table];
  if (!editingRow){ toast('Keine Zeile ausgew√§hlt', true); return; }
  if (!confirm('Wirklich l√∂schen?')) return;

  try{
    $('#btn-delete').disabled = true;
    $('#op-status').textContent = 'L√∂sche‚Ä¶';
    let q = client.from(table).delete();
    if (Array.isArray(def.pk)){
      def.pk.forEach(pk => { q = q.eq(pk, editingRow[pk]); });
    } else {
      q = q.eq(def.pk, editingRow[def.pk]);
    }
    const { error } = await q;
    if (error) throw error;
    $('#op-status').innerHTML = `<span class="success">üóë gel√∂scht</span>`;
    editingRow = null;
    buildForm(table, null);
    await loadRows(true);
  }catch(e){
    $('#op-status').innerHTML = `<span class="error">‚ùå ${e.message}</span>`;
  }finally{
    $('#btn-delete').disabled = false;
  }
}

function toast(msg, isErr=false){
  $status.textContent = msg;
  $status.className = isErr ? 'error' : 'success';
  setTimeout(()=>{ $status.textContent='Bereit'; $status.className='muted'; }, 3000);
}
function showError(err){ console.error(err); toast(err.message || String(err), true); }

// ==== Events ====
document.addEventListener('DOMContentLoaded', ()=>{
  initSupabase();
  buildTableSelect();
  buildForm(currentTable, null);
  loadRows(true);

  $('#btn-connect').onclick = ()=>{ initSupabase(); loadRows(true); };
  $('#table-select').onchange = (e)=>{ currentTable = e.target.value; page=0; buildForm(currentTable,null); loadRows(true); };
  $('#btn-load').onclick = ()=> loadRows(true);
  $('#btn-new').onclick = ()=> buildForm(currentTable, null);
  $('#btn-refresh').onclick = ()=> loadRows(false);
  $('#btn-search').onclick = ()=> loadRows(true);
  $('#prev-page').onclick = ()=> { if (page>0){ page--; loadRows(false);} };
  $('#next-page').onclick = ()=> { page++; loadRows(false); };
  $('#btn-save').onclick = (e)=>{ e.preventDefault(); doSave(); };
  $('#btn-delete').onclick = (e)=>{ e.preventDefault(); doDelete(); };
  $('#btn-clear').onclick = (e)=>{ e.preventDefault(); buildForm(currentTable, null); };

  // Schnellzugriff
  document.querySelectorAll('[data-jump]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentTable = btn.dataset.jump;
      $('#table-select').value = currentTable;
      buildForm(currentTable,null);
      loadRows(true);
    });
  });

  // Strg+K ‚Üí Fokus Suche
  document.addEventListener('keydown', (ev)=>{
    if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase()==='k'){
      ev.preventDefault(); $('#search-input').focus();
    }
  });
});
</script>
</body>
</html>
