<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Borbarad-DB Data Filler (DSA 4.1 Sonderfertigkeiten)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      /* Modernere Farbpalette */
      --bg-dark: #0f172a; /* Sehr dunkelblau */
      --bg-panel: #1e293b; /* Panel-Hintergrund */
      --bg-card: #334155; /* Karten-Hintergrund */
      --bg-input: #475569; /* Input-Hintergrund */
      --text-primary: #f1f5f9; /* Haupttext */
      --text-secondary: #cbd5e1; /* Sekund√§rtext */
      --accent-primary: #60a5fa; /* Prim√§rer Akzent (Blau) */
      --accent-secondary: #818cf8; /* Sekund√§rer Akzent (Violett) */
      --success: #34d399; /* Erfolg (Gr√ºn) */
      --warning: #fbbf24; /* Warnung (Gelb) */
      --error: #f87171; /* Fehler (Rot) */
      --border: #4b5563; /* Rahmenfarbe */
      --shadow: rgba(0, 0, 0, 0.5); /* Schatten */

      /* Abgerundete Ecken */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: linear-gradient(90deg, var(--bg-panel), #2d3748);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 8px var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .status-pill {
      background-color: var(--bg-card);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      border: 1px solid var(--border);
    }

    header .status-pill .status-value {
      color: var(--accent-primary);
      font-weight: 500;
    }

    /* Hauptcontainer */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar */
    aside {
      width: 300px;
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .card {
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px var(--shadow);
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background-color: var(--bg-input);
      color: var(--text-primary);
      font-size: 1rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #5a677d;
    }

    .btn-danger {
      background-color: var(--error);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background-color: #ef4444;
    }

    .btn-icon {
      padding: 8px;
      font-size: 1.1rem;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .cols-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .help-text {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    kbd {
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-fk {
      background-color: #4f46e5;
      color: white;
    }

    .badge-enum {
      background-color: #7c3aed;
      color: white;
    }

    .badge-readonly {
      background-color: #6b7280;
      color: white;
    }

    .quick-access-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .quick-access-grid .btn {
      font-size: 0.85rem;
      padding: 8px 12px;
    }

    /* Main Content */
    main {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .toolbar > * {
      flex-shrink: 0;
    }

    .search-container {
      flex: 1;
      max-width: 500px;
      position: relative;
    }

    .search-container input {
      padding-left: 36px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .table-info {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--bg-card);
      color: var(--text-primary);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background-color: #2d3748;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background-color: #4a5568;
    }

    .action-cell {
      display: flex;
      gap: 8px;
    }

    .form-card {
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px var(--shadow);
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .form-header h2 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-mode {
      font-size: 0.9rem;
      color: var(--accent-primary);
      background-color: rgba(96, 165, 250, 0.1);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 20px;
    }

    .op-status {
      flex: 1;
      font-size: 0.9rem;
      min-width: 200px;
    }

    .op-status .success {
      color: var(--success);
    }

    .op-status .error {
      color: var(--error);
    }

    /* Responsive Design */
    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
      }

      aside {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .cols-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      header {
        padding: 12px 16px;
        gap: 10px;
      }

      header h1 {
        font-size: 1.2rem;
      }

      .status-pill {
        font-size: 0.8rem;
        padding: 4px 8px;
      }

      main {
        padding: 16px;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-container {
        max-width: 100%;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .cols-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>üßô‚Äç‚ôÇÔ∏è Borbarad-DB Data Filler</h1>
  <div class="status-pill">Status: <span id="status" class="status-value">Verbinde‚Ä¶</span></div>
  <div class="status-pill">Projekt: <span class="status-value">Supabase</span></div>
</header>

<div class="main-container">
  <aside>
    <div class="card">
      <h3>üîó Verbindung</h3>
      <div class="stack">
        <div class="form-field">
          <label for="sb-url">Supabase URL</label>
          <input id="sb-url" type="text" value="https://uzgizoikrricctzznlzr.supabase.co" />
        </div>
        <div class="form-field">
          <label for="sb-key">Anon/Public API Key</label>
          <input id="sb-key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6Z2l6b2lrcnJpY2N0enpubHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MDc1MTksImV4cCI6MjA3MjQ4MzUxOX0.MJFMo6PrBXq_3xQGqYeyMKZx0JTqouFBW3eqteXgsm8" />
        </div>
        <button id="btn-connect" class="btn btn-primary">Neu verbinden</button>
        <div class="help-text">‚ö†Ô∏è Nutze hier nur <b>Public/Anon</b>-Keys. F√ºr Admin-Aufgaben <i>nicht</i> geeignet.</div>
      </div>
    </div>

    <div class="card">
      <h3>üìÇ Daten</h3>
      <div class="stack">
        <div class="form-field">
          <label for="table-select">Tabelle</label>
          <select id="table-select"></select>
        </div>
        <div class="btn-group">
          <button id="btn-load" class="btn btn-secondary">Laden</button>
          <button id="btn-new" class="btn btn-secondary">Neu anlegen</button>
        </div>
        <div class="help-text">Tipp: <kbd>Strg</kbd>+<kbd>K</kbd> f√ºr Suche in Datens√§tzen.</div>
      </div>
    </div>

    <div class="card">
      <h3>‚ö° Schnellzugriff</h3>
      <div class="quick-access-grid">
        <button class="btn btn-secondary" data-jump="sonderfertigkeit">Sonderfertigkeit</button>
        <button class="btn btn-secondary" data-jump="sf_stufe">Stufe</button>
        <button class="btn btn-secondary" data-jump="sf_kosten">AP-Kosten</button>
        <button class="btn btn-secondary" data-jump="sf_quelle">Quelle</button>
        <button class="btn btn-secondary" data-jump="sf_modifikator">Modifikator</button>
        <button class="btn btn-secondary" data-jump="sf_nutzung">Nutzung</button>
        <button class="btn btn-secondary" data-jump="sf_pre_sf">Voraus. SF</button>
        <button class="btn btn-secondary" data-jump="sf__talent">‚Üî SF‚ÜîTalent</button>
      </div>
    </div>

    <div class="card">
      <h3>‚ÑπÔ∏è Legende</h3>
      <div class="stack">
        <div><span class="badge badge-fk">FK</span> Fremdschl√ºssel-Dropdown</div>
        <div><span class="badge badge-enum">ENUM</span> feste Auswahl</div>
        <div><span class="badge badge-readonly">RO</span> Nur lesbar</div>
      </div>
    </div>
  </aside>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="search-container">
          <span class="search-icon">üîç</span>
          <input id="search-input" type="text" placeholder="Suche (z. B. name: Finte)" />
        </div>
        <button id="btn-search" class="btn btn-primary">Suchen</button>
        <span class="table-info" id="rows-count"></span>
        <span style="flex:1"></span>
        <button id="btn-refresh" class="btn btn-secondary btn-icon">üîÑ</button>
      </div>
      <div class="table-container">
        <table id="rows-table"></table>
      </div>
      <div class="pagination">
        <button id="prev-page" class="btn btn-secondary">‚óÄ Zur√ºck</button>
        <span class="table-info" id="page-info"></span>
        <button id="next-page" class="btn btn-secondary">Weiter ‚ñ∂</button>
      </div>
    </div>

    <div class="form-card">
      <div class="form-header">
        <h2>üìù Formular</h2>
        <span id="form-mode" class="form-mode">Neu</span>
      </div>
      <form id="editor" class="form-grid"></form>
      <div class="form-actions">
        <button id="btn-save" class="btn btn-primary">üíæ Speichern</button>
        <button id="btn-delete" class="btn btn-danger">üóë L√∂schen</button>
        <button id="btn-clear" class="btn btn-secondary">Felder leeren</button>
        <span id="op-status" class="op-status"></span>
      </div>
    </div>
  </main>
</div>

<script>
/** ========= Basiskonfiguration ========= **/
const ENUMS = {
  attribute_code: ['MU','KL','IN','CH','FF','GE','KO','KK'],
  aktionstyp: ['passiv','frei','aktion','reaktion','permanent'],
  ressourcen_typ: ['AP','AsP','KaP','AuP','LE','sonstige'],
  voraussetz_logik: ['alle','mindestens_eine'],
  sf_status: ['offiziell','inoffiziell','hausregel','entfernt'],
  wirk_operator: ['add','mult','ersetze'],
  vergleich_op: ['>=','>','=','<=','<','!=']
};
// Schema-Definition: Tabellen + Spalten (Typen + optionale FK)
const SCHEMA = {
  // === Stammdaten ===
  talent: {
    label: 'Talente',
    pk: 'id',
    columns: {
      id: {type:'integer', readonly:true},
      name: {type:'text', required:true},
      gruppe: {type:'text', required:true},
      regelwerk: {type:'text', default:'DSA 4.1'}
    }
  },
  waffengruppe: {
    label:'Waffengruppen',
    pk:'id',
    columns: { id:{type:'integer',readonly:true}, name:{type:'text',required:true} }
  },
  tradition: {
    label:'Traditionen',
    pk:'id',
    columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true}, art:{type:'text',required:true} }
  },
  vorteil: { label:'Vorteile', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },
  nachteil: { label:'Nachteile', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },
  quelle: {
    label:'Quellen',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      code:{type:'text',required:true},
      titel:{type:'text',required:true},
      auflage:{type:'text'},
      verlag:{type:'text'},
      jahr:{type:'integer'}
    }
  },
  tag: { label:'Tags', pk:'id', columns:{ id:{type:'integer',readonly:true}, name:{type:'text',required:true} } },
  // === Kern: Sonderfertigkeit ===
  sonderfertigkeit: {
    label:'Sonderfertigkeiten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      name:{type:'text',required:true},
      kurzname:{type:'text'},
      kategorie:{type:'text',required:true}, // Freitext: Allgemein/Kampf/Magie/Liturgie/‚Ä¶
      status:{type:'enum', enum:'sf_status', default:'offiziell'},
      regelwerk:{type:'text', default:'DSA 4.1'},
      beschreibung_kurz:{type:'textarea'},
      einzigartig:{type:'boolean', default:false},
      stapelbar:{type:'boolean', default:false},
      bemerkung:{type:'textarea'}
    }
  },
  // Verkn√ºpfungen
  sf__tag: {
    label:'SF ‚Üî Tag',
    pk:['sf_id','tag_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      tag_id:{type:'fk', ref:{table:'tag', value:'id', label:'name'}, required:true}
    }
  },
  sf__talent: {
    label:'SF ‚Üî Talent',
    pk:['sf_id','talent_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      talent_id:{type:'fk', ref:{table:'talent', value:'id', label:'name'}, required:true}
    }
  },
  sf__waffengruppe: {
    label:'SF ‚Üî Waffengruppe',
    pk:['sf_id','waffengruppe_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      waffengruppe_id:{type:'fk', ref:{table:'waffengruppe', value:'id', label:'name'}, required:true}
    }
  },
  sf__tradition: {
    label:'SF ‚Üî Tradition',
    pk:['sf_id','tradition_id'],
    columns:{
      sf_id:{type:'fk', ref:{table:'sonderfertigkeit', value:'id', label:'name'}, required:true},
      tradition_id:{type:'fk', ref:{table:'tradition', value:'id', label:'name'}, required:true}
    }
  },
  // Stufen/Varianten + Kosten + Quelle
  sf_stufe: {
    label:'Stufen/Varianten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      bezeichnung:{type:'text',required:true},
      reihenfolge:{type:'integer',default:1}
    }
  },
  sf_kosten:{
    label:'AP-Kosten',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      betrag:{type:'integer'},
      ist_variabel:{type:'boolean',default:false},
      formel:{type:'text'},
      bemerkung:{type:'textarea'}
    }
  },
  sf_quelle:{
    label:'SF-Quelle',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      quelle_id:{type:'fk',ref:{table:'quelle',value:'id',label:'code'}, required:true},
      seite:{type:'text'},
      errata_hint:{type:'textarea'}
    }
  },
  // Voraussetzungen
  sf_voraussetzung_text:{
    label:'Voraussetzung (Text)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      text:{type:'textarea',required:true}
    }
  },
  sf_pre_attribut:{
    label:'Voraussetzung: Attribut',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      attribut:{type:'enum',enum:'attribute_code',required:true},
      operator:{type:'enum',enum:'vergleich_op',default:'>='},
      wert:{type:'integer',required:true}
    }
  },
  sf_pre_talent:{
    label:'Voraussetzung: Talent',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      talent_id:{type:'fk',ref:{table:'talent',value:'id',label:'name'}, required:true},
      min_taw:{type:'integer',required:true}
    }
  },
  sf_pre_sf:{
    label:'Voraussetzung: SF',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      braucht_sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      min_stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}}
    }
  },
  sf_pre_vorteil:{
    label:'Voraussetzung: Vorteil',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      vorteil_id:{type:'fk',ref:{table:'vorteil',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_nachteil:{
    label:'Voraussetzung: Nachteil',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      nachteil_id:{type:'fk',ref:{table:'nachteil',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_kultur:{
    label:'Voraussetzung: Kultur',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      kultur:{type:'text',required:true}
    }
  },
  sf_pre_profession:{
    label:'Voraussetzung: Profession',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      profession:{type:'text',required:true}
    }
  },
  sf_pre_tradition:{
    label:'Voraussetzung: Tradition',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      tradition_id:{type:'fk',ref:{table:'tradition',value:'id',label:'name'}, required:true}
    }
  },
  sf_pre_waffengruppe:{
    label:'Voraussetzung: Waffengruppe',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      waffengruppe_id:{type:'fk',ref:{table:'waffengruppe',value:'id',label:'name'}, required:true}
    }
  },
  sf_voraussetzungsgruppe:{
    label:'Voraussetzungsgruppe',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      logik:{type:'enum',enum:'voraussetz_logik',default:'alle'},
      bemerkung:{type:'text'}
    }
  },
  sf_voraussetzungsgruppe_item:{
    label:'Voraussetzungsgruppe-Item',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      gruppe_id:{type:'fk',ref:{table:'sf_voraussetzungsgruppe',value:'id',label:'id'}, required:true},
      typ:{type:'text',required:true},
      ref_id:{type:'integer'},
      text:{type:'text'}
    }
  },
  // Nutzung / Ressourcen
  sf_nutzung:{
    label:'Nutzung',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      aktivierung:{type:'enum',enum:'aktionstyp',default:'passiv'},
      aktionen_kosten:{type:'numeric'},
      dauer_typ:{type:'text'},
      dauer_wert:{type:'text'},
      bedingung:{type:'text'}
    }
  },
  sf_nutzung_ressource:{
    label:'Nutzungs-Ressource',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      nutzung_id:{type:'fk',ref:{table:'sf_nutzung',value:'id',label:'id'}, required:true},
      typ:{type:'enum',enum:'ressourcen_typ',required:true},
      betrag:{type:'integer'},
      formel:{type:'text'},
      bemerkung:{type:'text'}
    }
  },
  // Wirkung / Modifikatoren / Konflikte / Versionen
  sf_wirkung_text:{
    label:'Wirkung (Text)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      text:{type:'textarea',required:true}
    }
  },
  sf_modifikator:{
    label:'Modifikator (maschinenlesbar)',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      stufe_id:{type:'fk',ref:{table:'sf_stufe',value:'id',label:'bezeichnung'}},
      ziel_typ:{type:'text',required:true},
      ziel_ref:{type:'text'},
      operator:{type:'enum',enum:'wirk_operator',default:'add'},
      wert_num:{type:'numeric'},
      wert_wuerfel:{type:'text'},
      bedingung:{type:'text'},
      stapelregel:{type:'text'}
    }
  },
  sf_konflikt:{
    label:'Konflikt / Ausschluss',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      ausschluss_sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      bemerkung:{type:'text'}
    }
  },
  sf_version:{
    label:'Version/√Ñnderung',
    pk:'id',
    columns:{
      id:{type:'integer',readonly:true},
      sf_id:{type:'fk',ref:{table:'sonderfertigkeit',value:'id',label:'name'}, required:true},
      gueltig_ab:{type:'date',required:true},
      aenderung:{type:'textarea',required:true}
    }
  }
};
// ======= Laufzeit =======
let client = null;
let currentTable = 'sonderfertigkeit';
let editingRow = null;
let page = 0, pageSize = 25;
const $ = (sel) => document.querySelector(sel);
const $rowsTable = $('#rows-table');
const $rowsCount = $('#rows-count');
const $pageInfo = $('#page-info');
const $status = $('#status');
function initSupabase(){
  const url = $('#sb-url').value.trim();
  const key = $('#sb-key').value.trim();
  client = supabase.createClient(url, key, { auth: { persistSession: false } });
  $status.textContent = 'Verbunden';
  $status.className = 'status-value'; // Reset class
}
function fmt(v){
  if (v === null || v === undefined) return '‚Äî';
  if (typeof v === 'boolean') return v ? 'true' : 'false';
  return String(v);
}
function buildTableSelect(){
  const sel = $('#table-select');
  sel.innerHTML = '';
  Object.entries(SCHEMA).forEach(([t,def])=>{
    const opt = document.createElement('option');
    opt.value = t; opt.textContent = `${def.label} (${t})`;
    sel.appendChild(opt);
  });
  sel.value = currentTable;
}
function buildForm(table, row=null){
  const def = SCHEMA[table];
  const form = $('#editor');
  form.innerHTML = '';
  $('#form-mode').textContent = row ? `Bearbeiten (#${row[def.pk] ?? '‚Äì'})` : 'Neu';
  editingRow = row;
  for (const [col, meta] of Object.entries(def.columns)){
    const wrap = document.createElement('div'); wrap.className = 'form-field';
    
    const labelWrap = document.createElement('div'); labelWrap.className = 'form-field-header';
    const label = document.createElement('label');
    label.textContent = col;
    labelWrap.appendChild(label);
    
    let badges = [];
    if (meta.type === 'fk') badges.push('<span class="badge badge-fk">FK</span>');
    if (meta.type === 'enum') badges.push('<span class="badge badge-enum">ENUM</span>');
    if (meta.readonly) badges.push('<span class="badge badge-readonly">RO</span>');
    if (badges.length > 0) {
        labelWrap.innerHTML += badges.join(' ');
    }
    
    let input;
    const value = row ? row[col] : (meta.default ?? null);
    if (meta.type === 'textarea'){ 
        input = document.createElement('textarea'); 
        input.rows = 4;
        input.value = value ?? ''; 
    }
    else if (meta.type === 'boolean'){ 
        input = document.createElement('select');
        ['', 'true', 'false'].forEach(v=>{
            const o=document.createElement('option'); 
            o.value=v; 
            o.textContent=v===''?'(NULL)':(v==='true'?'Ja':'Nein'); 
            input.appendChild(o);
        });
        input.value = value === null || value === undefined ? '' : (value ? 'true' : 'false');
    }
    else if (meta.type === 'enum'){
        input = document.createElement('select');
        const opts = ENUMS[meta.enum] || [];
        const nullOpt = document.createElement('option'); nullOpt.value=''; nullOpt.textContent='(NULL)';
        input.appendChild(nullOpt);
        opts.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;input.appendChild(o);});
        input.value = value ?? (meta.default ?? '');
    }
    else if (meta.type === 'fk'){
        input = document.createElement('select');
        input.dataset.fk = JSON.stringify(meta.ref);
        const nullOpt = document.createElement('option'); nullOpt.value=''; nullOpt.textContent='(NULL)';
        input.appendChild(nullOpt);
        // sp√§ter bef√ºllen:
        populateFkOptions(input, value);
        // Suche-Button
        const btnWrap = document.createElement('div');
        btnWrap.className = 'stack';
        const btn = document.createElement('button'); 
        btn.type='button'; 
        btn.className='btn btn-secondary btn-icon'; 
        btn.textContent='üîé';
        btn.title = 'FK-Optionen neu laden';
        btn.onclick = ()=> populateFkOptions(input, input.value || null, true);
        btnWrap.appendChild(input);
        btnWrap.appendChild(btn);
        wrap.appendChild(labelWrap);
        wrap.appendChild(btnWrap);
        form.appendChild(wrap);
        continue; // Skip the rest of the loop for this field
    }
    else if (meta.type === 'integer'){ 
        input = document.createElement('input'); 
        input.type='number'; 
        input.step='1'; 
        input.value = value ?? ''; 
    }
    else if (meta.type === 'numeric'){ 
        input = document.createElement('input'); 
        input.type='number'; 
        input.step='any'; 
        input.value = value ?? ''; 
    }
    else if (meta.type === 'date'){ 
        input = document.createElement('input'); 
        input.type='date'; 
        input.value = value ?? ''; 
    }
    else { 
        input = document.createElement('input'); 
        input.type='text'; 
        input.value = value ?? ''; 
    }
    input.id = `f_${col}`;
    if (meta.readonly) input.disabled = true;
    wrap.appendChild(labelWrap);
    wrap.appendChild(input);
    form.appendChild(wrap);
  }
}
async function populateFkOptions(selectEl, currentValue=null, forceReload=false){
  try{
    const ref = JSON.parse(selectEl.dataset.fk);
    if (!ref || !ref.table) return;
    // Wenn schon Optionen da sind und kein Reload gefordert ist, nicht doppelt laden
    if (selectEl.options.length>1 && !forceReload) { selectEl.value = currentValue ?? ''; return; }
    selectEl.disabled = true;
    const { data, error } = await client.from(ref.table)
      .select(`${ref.value}, ${ref.label}`).order(ref.label, { ascending: true }).limit(500);
    if (error) throw error;
    // Reset au√üer (NULL)
    [...selectEl.options].slice(1).forEach(o=>o.remove());
    data.forEach(row=>{
      const o=document.createElement('option');
      o.value=row[ref.value];
      o.textContent=`${row[ref.label]} (#${row[ref.value]})`;
      selectEl.appendChild(o);
    });
    selectEl.value = currentValue ?? '';
  }catch(e){
    console.error(e);
    toast(`FK-Optionen nicht ladbar: ${e.message}`, true);
  }finally{
    selectEl.disabled = false;
  }
}
function parseSearch(q){
  // einfache Syntax: "name: Finte" oder "id=12"
  const parts = q.split(/\s+/).filter(Boolean);
  const filters = [];
  for (const p of parts){
    const m = p.match(/^([^:=<>!]+)\s*([:=<>!]{1,2})\s*(.+)$/);
    if (m){ filters.push({col:m[1], op:m[2], val:m[3]}); }
  }
  return filters;
}
async function loadRows(resetPage=false){
  if (resetPage) page = 0;
  const table = currentTable;
  const def = SCHEMA[table];
  const from = page*pageSize;
  const to = from + pageSize - 1;
  let query = client.from(table).select('*', { count: 'exact' }).range(from, to);
  // einfache Default-Sortierung
  if (def.pk && typeof def.pk === 'string') query = query.order(def.pk, { ascending:false });
  // Suche
  const q = $('#search-input').value.trim();
  if (q){
    const fs = parseSearch(q);
    fs.forEach(f=>{
      const opMap = { ':':'ilike', '=':'eq', '==':'eq', '!=':'neq', '>':'gt', '>=':'gte', '<':'lt', '<=':'lte' };
      const sop = opMap[f.op] || 'ilike';
      let val = f.val;
      if (sop==='ilike') val = `%${val}%`;
      query = query.filter(f.col, sop, val);
    });
  }
  const { data, error, count } = await query;
  if (error){ showError(error); return; }
  renderRowsTable(data, def);
  $rowsCount.textContent = `${count ?? '?'} Datens√§tze`;
  $pageInfo.textContent = `Seite ${page+1}`;
}
function renderRowsTable(rows, def){
  const cols = Object.keys(def.columns);
  $rowsTable.innerHTML = '';
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
  const acth = document.createElement('th'); acth.textContent='Aktionen'; trh.appendChild(acth);
  thead.appendChild(trh); $rowsTable.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach((row)=>{
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      const td=document.createElement('td');
      td.textContent = fmt(row[c]);
      tr.appendChild(td);
    });
    const act = document.createElement('td');
    act.className = 'action-cell';
    const b1 = document.createElement('button'); 
    b1.className='btn btn-secondary btn-icon'; 
    b1.textContent='‚úèÔ∏è';
    b1.title = 'Bearbeiten';
    b1.onclick = ()=> buildForm(currentTable, row);
    const b2 = document.createElement('button'); 
    b2.className='btn btn-danger btn-icon'; 
    b2.textContent='üóë';
    b2.title = 'L√∂schen';
    b2.onclick = ()=> { 
        if (confirm('Wirklich l√∂schen?')) {
            buildForm(currentTable, row); 
            doDelete(); 
        }
    };
    act.appendChild(b1); 
    act.appendChild(b2);
    tr.appendChild(act);
    tbody.appendChild(tr);
  });
  $rowsTable.appendChild(tbody);
}
function readFormValues(table){
  const def = SCHEMA[table];
  const payload = {};
  for (const [col, meta] of Object.entries(def.columns)){
    const el = document.getElementById(`f_${col}`);
    if (!el || meta.readonly) continue; // PK/readonly nie mitschicken
    let v = el.value;
    if (v === '') v = null;
    if (meta.type === 'boolean') v = v === null ? null : (v === 'true');
    if (meta.type === 'integer' && v !== null) v = parseInt(v,10);
    if (meta.type === 'numeric' && v !== null) v = parseFloat(v);
    payload[col] = v;
  }
  return payload;
}
async function doSave(){
  const table = currentTable;
  const def = SCHEMA[table];
  const raw = readFormValues(table);
  try{
    $('#btn-save').disabled = true;
    $('#op-status').textContent = 'Speichere‚Ä¶';
    let res, error;
    if (Array.isArray(def.pk)){
      // Composite PK: Upsert mit allen PK-Feldern (hier keine Auto-ID)
      ({ data: res, error } = await client.from(table).upsert(raw).select());
    } else if (editingRow && def.pk){
      // Update: PK nie updaten
      const updatePayload = { ...raw };
      delete updatePayload[def.pk];
      ({ data: res, error } = await client.from(table)
        .update(updatePayload)
        .eq(def.pk, editingRow[def.pk])
        .select());
    } else {
      // Insert: PK entfernen (damit Sequence greift) und NULL-Felder weglassen
      const insertPayload = { ...raw };
      if (typeof def.pk === 'string') delete insertPayload[def.pk];
      for (const k of Object.keys(insertPayload)){
        if (insertPayload[k] === null) delete insertPayload[k];
      }
      ({ data: res, error } = await client.from(table).insert(insertPayload).select());
    }
    if (error) throw error;
    $('#op-status').innerHTML = `<span class="success">‚úÖ Gespeichert</span>`;
    await loadRows(true);
    if (res && res.length) buildForm(table, res[0]);
  }catch(e){
    $('#op-status').innerHTML = `<span class="error">‚ùå ${e.message}</span>`;
  }finally{
    $('#btn-save').disabled = false;
  }
}
async function doDelete(){
  const table = currentTable;
  const def = SCHEMA[table];
  if (!editingRow){ toast('Keine Zeile ausgew√§hlt', true); return; }
  // Confirm is now handled in the button click handler
  try{
    $('#btn-delete').disabled = true;
    $('#op-status').textContent = 'L√∂sche‚Ä¶';
    let q = client.from(table).delete();
    if (Array.isArray(def.pk)){
      def.pk.forEach(pk => { q = q.eq(pk, editingRow[pk]); });
    } else {
      q = q.eq(def.pk, editingRow[def.pk]);
    }
    const { error } = await q;
    if (error) throw error;
    $('#op-status').innerHTML = `<span class="success">üóë gel√∂scht</span>`;
    editingRow = null;
    buildForm(table, null);
    await loadRows(true);
  }catch(e){
    $('#op-status').innerHTML = `<span class="error">‚ùå ${e.message}</span>`;
  }finally{
    $('#btn-delete').disabled = false;
  }
}
function toast(msg, isErr=false){
  $status.textContent = msg;
  $status.className = isErr ? 'status-value error' : 'status-value success';
  setTimeout(()=>{ 
      $status.textContent='Bereit'; 
      $status.className='status-value'; 
  }, 3000);
}
function showError(err){ 
    console.error(err); 
    toast(err.message || String(err), true); 
}
// ==== Events ====
document.addEventListener('DOMContentLoaded', ()=>{
  initSupabase();
  buildTableSelect();
  buildForm(currentTable, null);
  loadRows(true);
  
  $('#btn-connect').onclick = ()=>{ 
      initSupabase(); 
      loadRows(true); 
  };
  $('#table-select').onchange = (e)=>{ 
      currentTable = e.target.value; 
      page=0; 
      buildForm(currentTable,null); 
      loadRows(true); 
  };
  $('#btn-load').onclick = ()=> loadRows(true);
  $('#btn-new').onclick = ()=> buildForm(currentTable, null);
  $('#btn-refresh').onclick = ()=> loadRows(false);
  $('#btn-search').onclick = ()=> loadRows(true);
  $('#prev-page').onclick = ()=> { 
      if (page>0){ 
          page--; 
          loadRows(false);
      }
  };
  $('#next-page').onclick = ()=> { 
      page++; 
      loadRows(false); 
  };
  $('#btn-save').onclick = (e)=>{ 
      e.preventDefault(); 
      doSave(); 
  };
  $('#btn-delete').onclick = (e)=>{ 
      e.preventDefault(); 
      // Confirmation moved here
      if (!editingRow) {
          toast('Keine Zeile ausgew√§hlt', true);
          return;
      }
      if (confirm('Wirklich l√∂schen?')) {
          doDelete(); 
      }
  };
  $('#btn-clear').onclick = (e)=>{ 
      e.preventDefault(); 
      buildForm(currentTable, null); 
  };
  // Schnellzugriff
  document.querySelectorAll('[data-jump]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentTable = btn.dataset.jump;
      $('#table-select').value = currentTable;
      buildForm(currentTable,null);
      loadRows(true);
    });
  });
  // Strg+K ‚Üí Fokus Suche
  document.addEventListener('keydown', (ev)=>{
    if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase()==='k'){
      ev.preventDefault(); 
      $('#search-input').focus();
    }
  });
});
</script>
</body>
</html>
